# 📊 Диаграммы работы системы скролла

## 🔄 Архитектура синхронизации

### До исправлений (проблемная версия):

```
┌─────────────────┐
│ CalendarHeader  │
│   (Master)      │
└────────┬────────┘
         │
         │ scroll event
         ▼
    ┌────────────────┐
    │ Обновление     │
    │ scrollLeft     │
    └────────┬───────┘
             │
             ▼
    ┌─────────────────┐
    │ CalendarCells   │
    │   (Slave)       │
    └────────┬────────┘
             │
             │ scroll event
             ▼
        ┌────────────────┐
        │ Обновление     │
        │ scrollLeft     │
        └────────┬───────┘
                 │
                 ▼
        ┌─────────────────┐
        │ CalendarHeader  │◄─── ❌ ЦИКЛ!
        │   (Master)      │
        └─────────────────┘

❌ Результат: Бесконечные обновления, рывки, зависания
```

### После исправлений (рабочая версия):

```
┌─────────────────────────┐
│ CalendarHeader (Master) │
│ isProgrammaticScroll=0  │
└───────────┬─────────────┘
            │
            │ USER scroll event
            ▼
    ┌───────────────────────┐
    │ Проверка флага:       │
    │ isProgrammaticScroll? │
    └───────────┬───────────┘
                │ NO
                ▼
    ┌───────────────────────┐
    │ Установить флаг: 1    │
    │ Обновить scrollLeft   │
    │ RAF: сбросить флаг→0  │
    └───────────┬───────────┘
                │
                ▼
    ┌─────────────────────────┐
    │ CalendarCells (Slave)   │
    │ isSyncingScroll=0       │
    └───────────┬─────────────┘
                │
                │ scroll event
                ▼
    ┌───────────────────────┐
    │ Проверка флага:       │
    │ isSyncingScroll?      │
    └───────────┬───────────┘
                │ NO (first time)
                ▼
    ┌───────────────────────┐
    │ Установить флаг: 1    │
    │ Обновить scrollLeft   │
    │ RAF: сбросить флаг→0  │
    └───────────┬───────────┘
                │
                ▼
    ┌─────────────────────────┐
    │ CalendarHeader (Master) │
    │ isProgrammaticScroll=1  │◄── ✅ Флаг защищает!
    └───────────┬─────────────┘
                │
                │ scroll event
                ▼
    ┌───────────────────────┐
    │ Проверка флага:       │
    │ isProgrammaticScroll? │
    └───────────┬───────────┘
                │ YES → RETURN
                ▼
            ✅ ЦИКЛ ПРЕРВАН!

✅ Результат: Плавная синхронизация, нет циклов
```

---

## 🎯 Алгоритм scrollToToday

### До исправлений (Projects):

```
scrollToToday()
    │
    ▼
┌────────────────────┐
│ Найти .today cell  │
└─────────┬──────────┘
          │
          ▼
    ❓ Ячейка есть?
          │
    ┌─────┴─────┐
   YES          NO
    │            │
    ▼            ▼
Скроллить    ❌ ОШИБКА!
             (ячейка не найдена)

❌ Проблема: Если сегодняшний день
             не в текущем диапазоне (3 месяца),
             ячейка не существует
```

### После исправлений (Projects & Employees):

```
scrollToToday()
    │
    ▼
┌─────────────────────────┐
│ ensureTodayInRange()    │
│ ┌─────────────────────┐ │
│ │ Проверить диапазон  │ │
│ └──────────┬──────────┘ │
│            │             │
│      ❓ Сегодня в       │
│         диапазоне?      │
│       ┌────┴────┐       │
│      YES       NO       │
│       │         │       │
│       │    ┌────▼─────┐│
│       │    │ goToToday││
│       │    │ (store)  ││
│       │    └────┬─────┘│
│       │         │       │
│       └─────────┴───┐   │
│                     │   │
│                 Подождать│
│                 рендер  │
└─────────────────────────┘
    │
    ▼
┌─────────────────────────┐
│ findTodayCell()         │
│ ┌─────────────────────┐ │
│ │ Попытка 1: найти    │ │
│ │ .today cell         │ │
│ └──────────┬──────────┘ │
│            │             │
│      ❓ Найдена?        │
│       ┌────┴────┐       │
│      YES       NO       │
│       │         │       │
│       │    ┌────▼─────┐│
│       │    │ nextTick ││
│       │    │ RAF      ││
│       │    │ Попытка 2││
│       │    └────┬─────┘│
│       │         │       │
│       │    ... до 4 раз │
│       └─────────┴───┐   │
└─────────────────────┼───┘
                      │
                      ▼
              ❓ Ячейка найдена?
                   ┌────┴────┐
                  YES       NO
                   │         │
                   ▼         ▼
        ┌──────────────┐  ✅ RETURN
        │ Установить   │     (безопасно)
        │ флаг         │
        │ isProgrammatic│
        │ =true        │
        └──────┬───────┘
               │
               ▼
        ┌──────────────┐
        │ Вычислить    │
        │ targetScroll │
        │ (центрировать)│
        └──────┬───────┘
               │
               ▼
        ┌──────────────┐
        │ scrollTo()   │
        │ smooth       │
        └──────┬───────┘
               │
               ▼
        ┌──────────────┐
        │ 2× RAF +     │
        │ setTimeout   │
        │ Сбросить флаг│
        └──────────────┘
               │
               ▼
        ✅ ГОТОВО!

✅ Результат: Всегда корректно
              находит и скроллит к сегодня
```

---

## 🛡️ Механизм защиты от циклов

### Временная диаграмма:

```
Время →
════════════════════════════════════════════════════════════════

USER ACTION: Скролл календаря
    │
    ├─ t=0ms ───────────────────────────────────────────────────
    │   CalendarHeader.handleScroll()
    │   │
    │   ├─ isProgrammaticScroll? NO
    │   │
    │   ├─ isProgrammaticScroll = true ✓
    │   │
    │   └─ CalendarCells.scrollLeft = X
    │
    ├─ t=1ms ───────────────────────────────────────────────────
    │   CalendarCells scroll event
    │   │
    │   ├─ CalendarCells.handleScroll()
    │   │
    │   ├─ isSyncingScroll? NO
    │   │
    │   ├─ isSyncingScroll = true ✓
    │   │
    │   └─ CalendarHeader.scrollLeft = X
    │
    ├─ t=2ms ───────────────────────────────────────────────────
    │   CalendarHeader scroll event
    │   │
    │   ├─ CalendarHeader.handleScroll()
    │   │
    │   ├─ isProgrammaticScroll? YES ← ✅ ЗАЩИТА!
    │   │
    │   └─ RETURN (не обновляем)
    │
    ├─ t=16ms (1 frame)─────────────────────────────────────────
    │   requestAnimationFrame callback
    │   │
    │   ├─ isProgrammaticScroll = false ✓
    │   │
    │   └─ isSyncingScroll = false ✓
    │
    └─ КОНЕЦ ЦИКЛА ════════════════════════════════════════════

✅ Результат: Один цикл синхронизации,
              дальнейшие события заблокированы флагами
```

---

## 📏 Порог синхронизации 1px

### Зачем нужен порог?

```
Без порога (плохо):
═══════════════════

scrollLeft = 100.0
    │
    ├─ Синхронизация → 100.0
    │
    ├─ Браузер округляет → 100.1 (sub-pixel)
    │
    ├─ Обнаружена разница! → Синхронизация → 100.1
    │
    ├─ Браузер округляет → 100.0
    │
    ├─ Обнаружена разница! → Синхронизация → 100.0
    │
    └─ ♾️ БЕСКОНЕЧНЫЙ ЦИКЛ микрообновлений

❌ Результат: Плохая производительность, микрорывки


С порогом 1px (хорошо):
═══════════════════════

scrollLeft = 100.0
    │
    ├─ Синхронизация → 100.0
    │
    ├─ Браузер округляет → 100.1
    │
    ├─ Разница < 1px → ИГНОРИРУЕМ ✅
    │
    └─ НЕТ лишних обновлений

✅ Результат: Оптимальная производительность,
              плавная работа
```

### Код проверки:

```javascript
// ❌ БЕЗ порога (плохо):
if (elementA.scrollLeft !== elementB.scrollLeft) {
  elementB.scrollLeft = elementA.scrollLeft;
}

// ✅ С порогом (хорошо):
if (Math.abs(elementA.scrollLeft - elementB.scrollLeft) > 1) {
  elementB.scrollLeft = elementA.scrollLeft;
}
```

---

## 🔄 requestAnimationFrame vs setTimeout

### setTimeout (проблемный):

```
User Action
    │
    ├─ t=0ms ────────────────────────────────
    │   isProgrammatic = true
    │   scrollTo(X)
    │   setTimeout(() => {
    │     isProgrammatic = false
    │   }, 50)
    │
    ├─ t=10ms ───────────────────────────────
    │   Browser renders ✓
    │
    ├─ t=20ms ───────────────────────────────
    │   Scroll event
    │   isProgrammatic? TRUE ✓
    │
    ├─ t=50ms ───────────────────────────────
    │   setTimeout callback
    │   isProgrammatic = false
    │   ❌ Слишком поздно! События уже обработаны
    │
    └─ или t=5ms ────────────────────────────
        setTimeout callback (если быстрая система)
        isProgrammatic = false
        ❌ Слишком рано! Рендеринг ещё не завершен

❌ Проблема: Race condition, непредсказуемое поведение
```

### requestAnimationFrame (правильный):

```
User Action
    │
    ├─ t=0ms ────────────────────────────────
    │   isProgrammatic = true
    │   scrollTo(X)
    │   requestAnimationFrame(() => {
    │     isProgrammatic = false
    │   })
    │
    ├─ t=16ms (следующий frame) ─────────────
    │   Browser renders ✓
    │   RAF callback
    │   isProgrammatic = false
    │   ✅ Синхронизировано с рендерингом!
    │
    └─ t=17ms+ ──────────────────────────────
        Новые scroll events
        isProgrammatic? FALSE
        ✅ Готовы к новым пользовательским событиям

✅ Результат: Точная синхронизация с рендерингом,
              предсказуемое поведение
```

---

## 📐 Схема компонентов

### Projects:

```
┌──────────────────────────────────────────────┐
│           Index.vue (родитель)               │
└────────────┬─────────────────┬───────────────┘
             │                 │
    ┌────────▼─────────┐  ┌────▼───────────────┐
    │ CalendarHeader   │  │ CalendarCells      │
    │ ════════════════ │  │ ══════════════════ │
    │                  │  │                    │
    │ States:          │  │ States:            │
    │ ├─ isProgrammatic│  │ ├─ isSyncingScroll │
    │ ├─ isAutoNavigate│  │ └─ cellsContainer  │
    │ └─ calendarHeader│  │                    │
    │                  │  │ Methods:           │
    │ Methods:         │  │ ├─ handleScroll()  │
    │ ├─ handleScroll()│  │ └─ syncFromHeader()│
    │ ├─ scrollToToday()│  │                   │
    │ ├─ ensureTodayIn...│  │                  │
    │ └─ findTodayCell()│  │                   │
    │                  │  │                    │
    │ #calendar-dates- │  │ .images-virtual-   │
    │  scroll          │  │  container         │
    └──────────────────┘  └────────────────────┘
            │                        │
            └────────┬───────────────┘
                     │
            Двусторонняя синхронизация
                 с защитой флагами
```

### Employees:

```
┌──────────────────────────────────────────────┐
│           Index.vue (родитель)               │
└────────────┬─────────────────┬───────────────┘
             │                 │
    ┌────────▼─────────┐  ┌────▼────────────────┐
    │ CalendarHeader   │  │ WorkloadTimeline    │
    │ ════════════════ │  │ ═══════════════════ │
    │                  │  │                     │
    │ States:          │  │ States:             │
    │ ├─ isProgrammatic│  │ ├─ isSyncingScroll  │
    │ ├─ isAutoNavigate│  │ ├─ containerRef     │
    │ └─ calendarHeader│  │ └─ headerEl         │
    │                  │  │                     │
    │ Methods:         │  │ Methods:            │
    │ ├─ handleScroll()│  │ ├─ handleScroll()   │
    │ ├─ scrollToToday()│  │ └─ syncWithHeader() │
    │ ├─ ensureTodayIn...│  │                    │
    │ └─ findTodayCell()│  │                    │
    │                  │  │                     │
    │ #calendar-dates- │  │ .images-virtual-    │
    │  scroll          │  │  container          │
    └──────────────────┘  └─────────────────────┘
            │                        │
            └────────┬───────────────┘
                     │
            Двусторонняя синхронизация
                 с защитой флагами
```

---

## 🎯 Состояния флагов

### Жизненный цикл флага:

```
┌─────────────────┐
│ Инициализация   │
│ flag = false    │
└────────┬────────┘
         │
         ▼
    ┌────────────┐
    │ Ожидание   │◄──────────────────┐
    │ события    │                   │
    └────┬───────┘                   │
         │                           │
         │ USER ACTION               │
         ▼                           │
    ┌────────────┐                   │
    │ flag=true  │                   │
    │ Выполнение │                   │
    └────┬───────┘                   │
         │                           │
         │ Запланировать             │
         │ requestAnimationFrame     │
         ▼                           │
    ┌────────────┐                   │
    │ Ожидание   │                   │
    │ следующего │                   │
    │ frame      │                   │
    └────┬───────┘                   │
         │                           │
         │ Next Frame                │
         ▼                           │
    ┌────────────┐                   │
    │ RAF        │                   │
    │ callback   │                   │
    │ flag=false │                   │
    └────┬───────┘                   │
         │                           │
         └───────────────────────────┘

✅ Цикл: false → true → false → repeat
```

### Таблица состояний:

| Время | isProgrammaticScroll | isSyncingScroll | Действие |
|-------|---------------------|-----------------|----------|
| t=0   | false               | false           | Ожидание |
| t=1   | true                | false           | Скролл календаря |
| t=2   | true                | true            | Синхронизация ячеек |
| t=3   | true                | true            | Блокировка циклов |
| t=16  | false               | false           | Сброс флагов, готов |

---

## 🎉 Итоговая схема работы системы

```
┌─────────────────────────────────────────────────────────────┐
│                     USER ACTION                             │
│                  (скролл, клик, навигация)                  │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
                  ┌────────────────┐
                  │ CalendarHeader │
                  └────────┬───────┘
                           │
            ┌──────────────┴──────────────┐
            │                             │
            ▼                             ▼
    ┌───────────────┐           ┌───────────────┐
    │ Проверка      │           │ Логика        │
    │ флагов        │           │ навигации     │
    │ ──────        │           │ ─────────     │
    │ isProgrammatic│           │ goToPrev/Next │
    │ isAutoNavigate│           │ scrollToToday │
    └───────┬───────┘           └───────┬───────┘
            │                           │
            │ Если false                │
            ▼                           ▼
    ┌───────────────┐           ┌───────────────┐
    │ Установить    │           │ Установить    │
    │ флаг = true   │           │ флаг = true   │
    └───────┬───────┘           └───────┬───────┘
            │                           │
            └─────────────┬─────────────┘
                          │
                          ▼
                ┌─────────────────┐
                │ Обновить        │
                │ scrollLeft      │
                └────────┬────────┘
                         │
                         ▼
                ┌─────────────────┐
                │ CalendarCells/  │
                │ WorkloadTimeline│
                └────────┬────────┘
                         │
                ┌────────┴────────┐
                │                 │
                ▼                 ▼
        ┌───────────────┐ ┌───────────────┐
        │ Проверка      │ │ Синхронизация │
        │ флага         │ │ обратно       │
        │ ──────        │ │               │
        │ isSyncingScroll│ │               │
        └───────┬───────┘ └───────┬───────┘
                │                 │
                │ Если false      │
                ▼                 ▼
        ┌───────────────┐ ┌───────────────┐
        │ Установить    │ │ Обновить      │
        │ флаг = true   │ │ CalendarHeader│
        └───────┬───────┘ └───────┬───────┘
                │                 │
                └────────┬────────┘
                         │
                         ▼
                ┌─────────────────┐
                │ Проверка флага  │
                │ в CalendarHeader│
                │ ──────────────  │
                │ isProgrammatic? │
                │ YES → RETURN ✅  │
                └────────┬────────┘
                         │
                         ▼
                ┌─────────────────┐
                │ requestAnimation│
                │ Frame           │
                │ ───────────────  │
                │ Сбросить все    │
                │ флаги = false   │
                └────────┬────────┘
                         │
                         ▼
                ┌─────────────────┐
                │ ✅ ГОТОВО!      │
                │ Синхронизировано│
                │ без циклов      │
                └─────────────────┘
```

---

**🎯 Главное: Флаги + Пороги + RAF = Стабильная система!**

